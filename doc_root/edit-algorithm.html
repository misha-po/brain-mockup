<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<base href="index.php" target="_self">
<link href="static/css/editor.css" rel="stylesheet" type="text/css" />

</head>

<body onload='editSetValues()'>
    <div id="constantPart" class='edit-package_part'>
        <table>
        <tr class='edit_row'>
            <td class="edit-row_label common_part">Algorithm type:</td>
            <td id='edit-algo_type'></td>
        </tr>
        <tr class='edit_row'>
            <td class="edit-row_label common_part">Algo code:</td>
            <td><input type="text" id="edit-algo_code" class='edit-row_data'/></td>
            <td class="edit-row_label common_part">Description:</td>
            <td rowspan="2"><textarea id="edit-description" class='edit-row_data' rows="3" ></textarea></td>
        </tr>
        <tr>
            <td class="edit-row_label common_part">Owner name:</td>
            <td><input type="text" id="edit-owner_name" class='edit-row_data'/></td>
        </tr>
        <tr>
            <td class="edit-row_label common_part">Owner email:</td>
            <td><input type="email" id="edit-owner_email" class='edit-row_data'/></td>
            <td class="edit-row_label common_part">File name:</td>
            <td><input type="text" id="edit-python_file_path" class='edit-row_data'/></td>
        </tr>
		<!-- ------------------------------------------------------------ -->
        <tr class='edit_row'>
			<td colspan="4">
			<hr>
			</td>
        </tr>
        <tr>
            <td colspan=2>
                <button id='edit-save-package' class='action-button' onclick='editSavePackage();'>Save</button>
            </td>
            <td colspan=2>
                <button id="edit-cancel" class='action-button' onclick='editCancelSavePackage(false);'>Cancel</button>
            </td>
        </tr>
        </table>
    </div>  
<script>
var popup_name = window.parent.document.getElementsByName('tab-name')[0].value+'-popup';
var algo_id = window.parent.document.getElementsByName('object-algo_id')[0].value;
console.log('popup_name='+popup_name+'-popup');
var out_df_id = -1;

function selectAlgoType(panelName) {
    if (panelName == 'basicAlgoPart') {
        document.getElementById("visibility_tags_header").style.visibility = "collapse";
        document.getElementById("visibility_tags_editor").style.visibility = "collapse";
        document.getElementById("edit-complex_type").style.visibility = "collapse";
        document.getElementById("edit-algo_output12").style.visibility = "visible";
        document.getElementById("edit-input_model2").style.visibility = "collapse";
        document.getElementById("edit-algo_universe").style.visibility = "visible";
        document.getElementById("edit-algo_output3").style.visibility = "collapse";

        document.getElementById("edit-output_features2").style.visibility = "visible";
        document.getElementById("edit-output_features3").style.visibility = "visible";
        document.getElementById("edit-feature_list_buttons").style.visibility = "visible";
        document.getElementById("edit-output_model").style.visibility = "collapse";
        document.getElementById("edit-output_model1").style.visibility = "collapse";
        document.getElementById("edit-add_feature").style.visibility = "collapse";
        document.getElementById("edit-add_feature3").style.visibility = "collapse";
    }
    if (panelName == 'complexAlgoPart') {
        document.getElementById("visibility_tags_header").style.visibility = "visible";
        document.getElementById("visibility_tags_editor").style.visibility = "visible";
        document.getElementById("edit-complex_type").style.visibility = "visible";
        document.getElementById("edit-algo_output12").style.visibility = "collapse";
        document.getElementById("edit-input_model2").style.visibility = "collapse";
        document.getElementById("edit-algo_universe").style.visibility = "collapse";
        document.getElementById("edit-algo_output3").style.visibility = "collapse";

        document.getElementById("edit-output_features2").style.visibility = "collapse";
        document.getElementById("edit-output_features3").style.visibility = "collapse";
        document.getElementById("edit-feature_list_buttons").style.visibility = "collapse";
        document.getElementById("edit-output_model").style.visibility = "visible";
        document.getElementById("edit-output_model1").style.visibility = "visible";
        document.getElementById("edit-add_feature").style.visibility = "collapse";
        document.getElementById("edit-add_feature3").style.visibility = "collapse";
    }
    if (panelName == 'invocationAlgoPart') {
        document.getElementById("visibility_tags_header").style.visibility = "collapse";
        document.getElementById("visibility_tags_editor").style.visibility = "collapse";
        document.getElementById("edit-complex_type").style.visibility = "collapse";
        document.getElementById("edit-algo_output12").style.visibility = "visible";
        document.getElementById("edit-input_model2").style.visibility = "visible";
        document.getElementById("edit-algo_universe").style.visibility = "collapse";
        document.getElementById("edit-algo_output3").style.visibility = "visible";

        document.getElementById("edit-output_features2").style.visibility = "collapse";
        document.getElementById("edit-output_features3").style.visibility = "collapse";
        document.getElementById("edit-feature_list_buttons").style.visibility = "collapse";
        document.getElementById("edit-output_model").style.visibility = "collapse";
        document.getElementById("edit-output_model").style.visibility = "collapse";
        document.getElementById("edit-add_feature").style.visibility = "visible";
        document.getElementById("edit-add_feature3").style.visibility = "visible";
        document.getElementById("edit-add_feature5").style.visibility = "collapse";
    }
}

function showEditPanel(show) {
    var show1 = show?"visible":"collapse";
    var show2 = show?"collapse":"visible";
    document.getElementById("edit-add_feature").style.visibility = show1;
    document.getElementById("edit-add_feature2").style.visibility = show1;
    document.getElementById("edit-add_feature3").style.visibility = show1;
    document.getElementById("edit-feature_list_buttons").style.visibility = show2;
    document.getElementById("edit-add_feature4").style.visibility = show1;
    document.getElementById("edit-add_feature5").style.visibility = show1;
}

function editOutputFeature(table_name) {
    var table = document.getElementById(table_name);
    for (var i = 1; i < table.rows.length; i++) {
        if (table.rows[i].classList.contains('selected_line')) {
            break;
        }
    }
    if (i >= table.rows.length)
        return;
    var tds = table.rows[i].getElementsByTagName('td');
    document.getElementById('edit-new_feature_name').value = tds[0].innerHTML;
    /*
    document.getElementById('edit-data_type');
    var e = document.getElementById('edit-data_type');
    var data_type = e.options[e.selectedIndex].text;
    e = document.getElementById('edit-data_constraint');
    var data_constraint = e.options[e.selectedIndex].text;
    var table = document.getElementById("edit-dataframes_list");
    var row = table.insertRow(-1);
    var td2 = row.insertCell(-1);
    td2.innerHTML = feature_name;
    var td3 = row.insertCell(-1);
    td3.innerHTML = data_type;
    var td4 = row.insertCell(-1);
    td4.innerHTML = data_constraint;
    var td5 = row.insertCell(-1);
    td5.innerHTML = document.getElementById("edit-is-target").checked?'Y':'N';
    var td6 = row.insertCell(-1);
    */
    showEditPanel(true);
}

function deleteSelectedRow(table_name) {
    var table = document.getElementById(table_name);
    for (var i = 1; i < table.rows.length; i++) {
        if (table.rows[i].classList.contains('selected_line')) {
            break;
        }
    }
    if (i < table.rows.length)
        table.deleteRow(i);
}

function addOutputDataFrame() {
    var table = document.getElementById("edit-dataframes_list");
    var row = table.insertRow(-1);

	var e;
	var e = document.getElementById('edit-new_feature_name')
	var feature_name = e.options[e.selectedIndex].text;

	e = document.getElementById('edit-data_type');
	var data_type_id = e.options[e.selectedIndex].value;
	e = document.getElementById('edit-data_constraint');
	var data_constraint_id = e.options[e.selectedIndex].value;

	var is_target = document.getElementById("edit-is-target").checked;
	var quality_metrics = document.getElementById('edit-quality_thresholds').value;
	var xhttp = new XMLHttpRequest();
	e = document.getElementById('edit-output_df_name');
	var out_df_id = e.options[e.selectedIndex].value;
	var dataframe_name = e.options[e.selectedIndex].innerHTML;
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			//console.log(this.responseText);
			var 	json_doc = JSON.parse(this.responseText);
			if (json_doc.length == 0) {
				return;
			}
			if (json_doc.error != 'OK') {
				alert(json_doc.error);
				return;
			}
			var pckg_data = json_doc.pckg_data;
			var table = document.getElementById("edit-dataframes_list");
			var row = table.insertRow(-1);
			var e;

			e = document.getElementById('edit-new_feature_name')
			var feature_name = e.options[e.selectedIndex].text;
			var feature_id = e.options[e.selectedIndex].value;


			e = document.getElementById('edit-data_type');
			var data_type = e.options[e.selectedIndex].text;
			e = document.getElementById('edit-data_constraint');
			var data_constraint = e.options[e.selectedIndex].text;

			var td1 = row.insertCell(-1);
			td1.innerHTML = feature_id;
			td1.style.visibility = 'hidden';
			var td2 = row.insertCell(-1);
			td2.innerHTML = feature_name;
			var td3 = row.insertCell(-1);
			td3.innerHTML = data_type;
			var td4 = row.insertCell(-1);
			td4.innerHTML = data_constraint;
			var td5 = row.insertCell(-1);
			td5.innerHTML = is_target?'Y':'N';
			var td6 = row.insertCell(-1);
			
			var opt = document.createElement("select"); 
			var tags = document.getElementById('edit-feature_tag_list').value.split(',');
			for (var i = 0; i < tags.length; i++) {
				var op = new Option();
				op.value = tags[i];
				op.text = tags[i];
				opt.options.add(op);      
			}
			
			td6.appendChild(opt);
			row.setAttribute('onclick', 'selectLine(this, "edit-dataframes_list", "tr")');
			showEditPanel(false);
		}
	};
	xhttp.open("GET", 'static/ajax/AddOutputFeature.php?df_id='+out_df_id
				+'&feature_name='+feature_name
				+'&data_type_id='+data_type_id
				+'&data_constraint_id='+data_constraint_id
				+'&is_target='+is_target
				+'&package_id='+pid
				+'&quality_metrics='+encodeURI(quality_metrics)
				+'&dataframe_name='+dataframe_name,true);
	xhttp.send();
}

function selectEditSchedule(view) {
    var view1 = 'edit-schedule_standard';
    var view2 = 'edit-schedule_custom1';
    var view3 = 'edit-schedule_custom2';
    if (view == 1) {
        document.getElementById(view1).style.display = "table-cell";
        document.getElementById(view2).style.display = "none";
        document.getElementById(view3).style.display = "none";
    }
    else {
        document.getElementById(view1).style.display = "none";
        document.getElementById(view2).style.display = "table-cell";
        document.getElementById(view3).style.display = "table-cell";
    }
    editSchedulePeriod();
}

/*
function editDeleteParam() {
    var elements = document.getElementById("edit-input_params").getElementsByTagName('li');
    for (var i = 0; i < elements.length; i++) {
        var li = elements[i];
        if (li.classList.contains('selected_line')) {
            li.parentNode.removeChild(li);
        }
    }
}
*/
function selectLine(element, list_name, tag_name) {
    var the_list = document.getElementById(list_name);
    var list_elems = the_list.getElementsByTagName(tag_name);
    for (var i = 0; i < list_elems.length; i++) {
        list_elems[i].classList.remove('selected_line');
    }
    element.classList.add('selected_line');
}

function editAddLiElement(panel_name, text_box, list_name, delete_button) {
    var edit_panel = document.getElementById(panel_name);
    if (edit_panel.style.display == "none") {
        edit_panel.style.display = "table-cell";
        document.getElementById(delete_button).style.visibility = "hidden";
    }
    else {
        edit_panel.style.display = "none";
        document.getElementById(delete_button).style.visibility = "visible";
        var text = document.getElementById(text_box).value;
        if (text == '') {
            return;
        }
        document.getElementById(text_box).value = "";
        
        var elements = document.getElementById(list_name).getElementsByTagName('li');
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].innerHTML == text) {
                return;
            }
        }
        var li = document.createElement("li");
        li.appendChild(document.createTextNode(text));
        li.onclick = function(){selectLine(li, list_name, 'li')}
        document.getElementById(list_name).appendChild(li);
    }
}

function editAddDataframe(panel_name, text_box, list_name, delete_button) {
    var edit_panel = document.getElementById(panel_name);
    if (edit_panel.style.display == "none") {
        edit_panel.style.display = "table-cell";
        document.getElementById(delete_button).style.visibility = "hidden";
    }
    else {
        edit_panel.style.display = "none";
        document.getElementById(delete_button).style.visibility = "visible";
		var tbl = document.getElementById(text_box);
        var text = tbl.options[tbl.selectedIndex].innerHTML;
        
        var elements = document.getElementById(list_name).getElementsByTagName('li');
        for (var i = 0; i < elements.length; i++) {
            if (elements[i].innerHTML == text) {
                return;
            }
        }
        var li = document.createElement("li");
        li.appendChild(document.createTextNode(text));
        li.onclick = function(){selectLine(li, list_name, 'li')}
        document.getElementById(list_name).appendChild(li);
    }
}


function editDeleteLiElement(elem_name) {
    var elements = document.getElementById(elem_name).getElementsByTagName('li');
    for (var i = 0; i < elements.length; i++) {
        var li = elements[i];
        if (li.classList.contains('selected_line')) {
            li.parentNode.removeChild(li);
        }
    }
}

function selectComplexAlgo(selection) {
    /*
    if(selection.value == 'manual') {
        document.getElementById("editparams_header").style.visibility = "visible";
        document.getElementById("editparams_editor").style.visibility = "visible";
    }
    else {
        document.getElementById("editparams_header").style.visibility = "collapse";
        document.getElementById("editparams_editor").style.visibility = "collapse";
    }
    */
}

function editSchedulePeriod() {
    var selector = document.getElementById('edit-schedule_custom11');
    var start_at = document.getElementById('edit-schedule_start_at');
    var start_on = document.getElementById('edit-schedule_start_on');
    var date = new Date();
    var time = ('0'+date.getHours()).substr(-2)+':'+('0'+date.getMinutes()).substr(-2);
    
    switch (selector[selector.selectedIndex].value) {
    case 'minutes':
        start_at.style.display = "table-cell";
        start_on.style.display = "none";
        start_at.format='HH:mm';
        start_at.value = time;
        break;
    case 'hours':
        start_at.style.display = "table-cell";
        start_on.style.display = "none";
        start_at.format='HH:mm';
        start_at.value = time;
        break;
    case 'days':
        start_at.style.display = "none";
        start_on.style.display = "table-cell";
//      start_on.value = "2014-02-09";
        start_on.value = (date.getYear()+1900)+'-'+(date.getMonth()+1)+'-'+date.getDate();
        break;
    case 'weeks':
        start_at.style.display = "none";
        start_on.style.display = "table-cell";
        start_on.value = (date.getYear()+1900)+'-'+(date.getMonth()+1)+'-'+date.getDate();
        break;
    case 'months':
        start_at.style.display = "none";
        start_on.style.display = "table-cell";
        start_on.value = (date.getYear()+1900)+'-'+(date.getMonth()+1)+'-'+date.getDate();
        break;
    }
}

function editSetValues() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var 	json_doc = JSON.parse(this.responseText);
			if (json_doc.length == 0) {
				return;
			}

			var algo_data = json_doc.algo_data;
			var elems = document.getElementsByName('algorithmType');
			if (algo_data != null) {
				for (var i=0; i < elems.length; i++) {
					if (elems[i].value == algo_data.algo_type)
						elems[i].checked = true;
					else 
						elems[i].checked = false;
				}
				aid = algo_data.aid;
				document.getElementById('edit-algo_code').value = algo_data.algo_code;
				document.getElementById('edit-owner_name').value = algo_data.owner_name;
				document.getElementById('edit-owner_email').value = algo_data.owner_email;
				document.getElementById('edit-description').value = algo_data.description;
				document.getElementById('edit-python_file_path').value = algo_data.egg_path;
			}
			else {
				aid = 0;
			}
			//////////////////////////////////////////////////////
			var algo_types = json_doc.algo_types;
			console.log(algo_types);

			var types = document.getElementById('edit-algo_type');
			types.innerHTML = '';
			var id;
			var name;
			for (var i = 0; i < algo_types.length; i++) {
				id = algo_types[i].id;
				name = algo_types[i].name;
				var button = document.createElement('input');
				button.setAttribute('type', 'radio');
				button.setAttribute('name', 'algorithmType');
				button.setAttribute('id', algo_types[i].name+'algorithmType');
				button.setAttribute('value', id);
				if (algo_data != null ) {
					if (algo_data.algo_type == name)
						button.setAttribute('checked', true);
				}
				var panel = name+'AlgoPart';
				//button.onchange=function(){selectAlgoType(name+"AlgoPart");};
				button.setAttribute('onchange', 'selectAlgoType("'+name+'AlgoPart")');
				//console.log(panel);
				types.appendChild(button);
				var label = document.createElement('label');
				label.setAttribute('for', name+'algorithmType');
				label.innerHTML = name;
				types.appendChild(label);
				var br = document.createElement('br');
				types.appendChild(br);
			}
		}
	};
	xhttp.open("GET", 'static/ajax/GetAlgoData.php?algo_id='+algo_id, true);
	xhttp.send();		

}

function editSavePackage() {
	var elems = document.getElementsByName('algorithmType');
	var algo_type;
	for (var i=0; i < elems.length; i++) {
		if (elems[i].checked) {
			algo_type = elems[i].value;
		}
	}
	var algo_data = {
		algo_type: algo_type,
		algo_code: document.getElementById('edit-algo_code').value,
		owner_name: document.getElementById('edit-owner_name').value,
		owner_email: document.getElementById('edit-owner_email').value,
		description: document.getElementById('edit-description').value
	}

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			console.log(this.responseText);
			var 	json_doc = JSON.parse(this.responseText);
			window.parent.document.getElementById('modal-title_close').onclick('edit-popup');
		}
	};
	xhttp.open("GET", 'static/ajax/SaveAlgoData.php?algo_id='+algo_id+'&algo_data='+encodeURI(JSON.stringify(algo_data)), true);
	xhttp.send();		
}

function editCancelSavePackage() {
	console.log(popup_name+'-popup_close');
	window.parent.document.getElementById(popup_name+'_close').onclick(popup_name);
}

/*
function addDataFrame() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var 	json_doc = JSON.parse(this.responseText);
			if (json_doc.length == 0) {
				return;
			}
			var pckg_data = json_doc.pckg_data;
			showEditPanel(true);
		}
	};
	xhttp.open("GET", 'static/ajax/GetFeatures.php?df_id='+out_df_id, true);
	xhttp.send();		
}
*/

function GetFeatures(e) {
	var df_id = e.options[e.selectedIndex].value;
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var 	json_doc = JSON.parse(this.responseText);
			if (json_doc.length == 0) {
				return;
			}
			editSetAvailableFeatures(json_doc.available_features)
		}
	};
	xhttp.open("GET", 'static/ajax/GetFeatures.php?df_id='+df_id, true);
	xhttp.send();		
	console.log(e.options[e.selectedIndex].text);
}

</script>
</body>
</html>
